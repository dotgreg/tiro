const { app, BrowserWindow } = require('electron')
const homedir = require('os').homedir();
const logFile = `${homedir}/log-electron-test.html` 
const envs = {
		os: process.platform,
		archi: process.arch,
}


// CREATING A SIMPLE VIEW REDIRECTING TO IFRAME
const createWindow = () => {
		const win = new BrowserWindow({
				width: 800,
				height: 600
		})
		win.loadURL("http://localhost:3023");
		// Sending it a param object
		win.webContents.executeJavaScript("window.tiroElectronObj = {port:3023}")
		//win.webContents.openDevTools()
}

app.whenReady().then(() => {
		startTiroServer(() => {
				createWindow();
		});
})

// starting the server with the determined path of RG binary
const startTiroServer = (cb) => {
		let hasStarted = false
		const rgPath = getRgPath();
		console.log({rgPath});
		execCmd('node', ['./build/server/server.js'], {
				env: {TIRO_RG_PATH: rgPath},
				onLog : (str) => {
						if ( !hasStarted) {
								if (str.includes('SERVER_LOAD_SUCCESS')) {
										hasStarted = true;
										if (cb) cb();
								}

						}
				}
		});
};

/*
 * SUPPORT FUNCTIONS
 */
const getRgPath = () => {
		let binPath = `rg`;

		let filename = 'rg'
		const appRootDir = require('app-root-dir').get();
		if (envs.os === 'win32') filename = `rg.exe`
		if (envs.os === 'darwin' && envs.archi === 'arm64') filename = `rg-darwin-arm.jpeg`
		if (envs.os === 'darwin' && envs.archi === 'x64') filename = `rg-darwin-x64`

		binPath = `${appRootDir}/bin/${filename}`;

		console.log({binPath});
		return binPath
}


const { exec } = require('child_process');
const execCmd = (cmd, params, p) => {
		const spawn = require( 'child_process' ).spawn;
		try {
				const child = spawn( cmd, params, {env: { ...process.env, ...p.env }});  
				child.stdout.on( 'data', data => {
						const str = `[${cmd}] : ${data}`;
						console.log( str );
						if (p && p.onLog) p.onLog(str)
				});
				child.stderr.on( 'data', data => {
						const str = `[${cmd} ERROR!] : ${data}`;
						console.log( str );
				});
		} catch (e) {
				alert(`[${cmd} ERROR JS!] : ${e}`);
		}
}

